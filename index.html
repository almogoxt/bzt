<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypixel Bazaar Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-xl overflow-hidden w-full max-w-4xl p-8 transform transition-all duration-300 hover:shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Hypixel Bazaar Tracker</h1>
        <p class="text-gray-500 text-center mb-6">אלמוג אוקסלדרויד הנסיך</p>
        
        <div class="relative mb-6">
            <input id="search-input" type="text" placeholder="חפש פריט..." class="w-full px-5 py-3 text-lg rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent transition-all duration-200 shadow-sm">
            <ul id="autocomplete-list" class="absolute z-10 w-full bg-white border border-gray-200 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-lg hidden">
            </ul>
        </div>
        
        <div id="price-summary" class="flex flex-col md:flex-row justify-around items-center space-y-4 md:space-y-0 md:space-x-4 mb-8">
            <div class="flex-1 bg-sky-100 p-6 rounded-2xl shadow-md text-center">
                <p class="text-lg text-gray-600 font-medium">Buy Order (קנייה)</p>
                <p id="buy-price" class="text-3xl font-bold text-sky-600 mt-2 transition-all duration-300">טוען...</p>
            </div>
            <div class="flex-1 bg-lime-100 p-6 rounded-2xl shadow-md text-center">
                <p class="text-lg text-gray-600 font-medium">Sell Order (מכירה)</p>
                <p id="sell-price" class="text-3xl font-bold text-lime-600 mt-2 transition-all duration-300">טוען...</p>
            </div>
        </div>

        <div id="status-message" class="mt-6 p-4 rounded-lg text-center font-medium hidden"></div>

        <div class="mt-8 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Profit Finder</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <input id="profit-margin-input" type="number" min="0" placeholder="הכנס רווח מינימלי (מטבעות)" class="w-full sm:w-60 px-5 py-3 text-lg rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 shadow-sm text-center">
                <button id="find-profit-button" class="w-full sm:w-auto px-6 py-3 bg-purple-600 text-white font-bold rounded-full shadow-lg hover:bg-purple-700 transition-colors duration-200">
                    חפש פריטים רווחיים
                </button>
            </div>
        </div>

        <div id="profit-list-container" class="mt-8 hidden">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">פריטים עם רווח מעל המינימום</h3>
            <ul id="profit-list" class="space-y-2 bg-gray-50 p-4 rounded-lg shadow-inner max-h-96 overflow-y-auto">
            </ul>
        </div>
    </div>

    <script>
        const BAZAAR_API_URL = "https://api.hypixel.net/v2/skyblock/bazaar";
        
        let allBazaarItems = [];
        let bazaarData = {};
        let selectedItemId = null;
        let updateLiveIntervalId = null;

        const searchInput = document.getElementById('search-input');
        const autocompleteList = document.getElementById('autocomplete-list');
        const buyPriceEl = document.getElementById('buy-price');
        const sellPriceEl = document.getElementById('sell-price');
        const statusMessageEl = document.getElementById('status-message');

        const profitMarginInput = document.getElementById('profit-margin-input');
        const findProfitButton = document.getElementById('find-profit-button');
        const profitListContainer = document.getElementById('profit-list-container');
        const profitListEl = document.getElementById('profit-list');

        // Function to display a status message
        function showMessage(message, type = 'info') {
            statusMessageEl.textContent = message;
            statusMessageEl.className = 'mt-6 p-4 rounded-lg text-center font-medium';
            statusMessageEl.classList.add('block');
            if (type === 'error') {
                statusMessageEl.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                statusMessageEl.classList.add('bg-green-100', 'text-green-700');
            } else {
                statusMessageEl.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        async function fetchBazaarData() {
            showMessage("מאחזר נתוני בזאר חיים...");
            try {
                const response = await fetch(BAZAAR_API_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                bazaarData = data.products;
                allBazaarItems = Object.keys(bazaarData).sort();
                showMessage("נתוני הבזאר נטענו בהצלחה!", 'success');
                return true;
            } catch (error) {
                console.error("Error fetching bazaar data:", error);
                showMessage("שגיאה באחזור נתוני הבזאר. אנא בדוק את חיבור האינטרנט שלך.", 'error');
                return false;
            }
        }

        function updatePriceSummary() {
            if (!selectedItemId || !bazaarData[selectedItemId]) {
                buyPriceEl.textContent = "N/A";
                sellPriceEl.textContent = "N/A";
                return;
            }

            const itemData = bazaarData[selectedItemId];
            const sellOrders = itemData.sell_summary;
            const topSellPrice = sellOrders.length > 0 ? sellOrders[0].pricePerUnit : "N/A";
            sellPriceEl.textContent = typeof topSellPrice === 'number' ? `${topSellPrice.toLocaleString()}` : 'N/A';
            
            const buyOrders = itemData.buy_summary;
            const topBuyPrice = buyOrders.length > 0 ? buyOrders[0].pricePerUnit : "N/A";
            buyPriceEl.textContent = typeof topBuyPrice === 'number' ? `${topBuyPrice.toLocaleString()}` : 'N/A';
        }

        // Functions to save and load state using localStorage
        function saveStateToLocalStorage() {
            if (selectedItemId) {
                localStorage.setItem('lastSelectedItem', selectedItemId);
            }
        }

        function loadStateFromLocalStorage() {
            return localStorage.getItem('lastSelectedItem');
        }

        // --- New Profit Finder Feature Functions ---

        /**
         * Calculates the profit (in coins) based on the difference between buy and sell prices.
         */
        function calculateProfit(buyOrderPrice, sellOrderPrice) {
            return buyOrderPrice - sellOrderPrice;
        }

        function filterByProfit() {
            const minProfit = parseFloat(profitMarginInput.value);
            if (isNaN(minProfit) || minProfit < 0) {
                showMessage("אנא הזן מספר חיובי עבור הרווח המינימלי.", 'error');
                return;
            }
            
            showMessage("מחפש פריטים רווחיים...");
            profitListEl.innerHTML = '';
            const profitableItems = [];

            for (const itemId in bazaarData) {
                const item = bazaarData[itemId];
                const sellSummary = item.sell_summary;
                const buySummary = item.buy_summary;

                // Check for valid buy and sell prices
                if (sellSummary.length > 0 && buySummary.length > 0) {
                    const topBuyOrderPrice = buySummary[0].pricePerUnit;
                    const topSellOrderPrice = sellSummary[0].pricePerUnit;

                    const profit = calculateProfit(topBuyOrderPrice, topSellOrderPrice);

                    if (profit >= minProfit) {
                        profitableItems.push({
                            name: itemId,
                            profit: profit,
                            buyPrice: topBuyOrderPrice,
                            sellPrice: topSellOrderPrice
                        });
                    }
                }
            }

            if (profitableItems.length > 0) {
                // Sort by profit in descending order
                profitableItems.sort((a, b) => b.profit - a.profit);
                displayFilteredResults(profitableItems);
            } else {
                showMessage("לא נמצאו פריטים העומדים בדרישות הרווח המינימלי.", 'info');
                profitListContainer.classList.add('hidden');
            }
        }

        function displayFilteredResults(items) {
            profitListContainer.classList.remove('hidden');
            profitListEl.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-white rounded-md shadow-sm border border-gray-200 hover:bg-gray-100 transition-colors duration-100 cursor-pointer';
                li.innerHTML = `
                    <div class="font-semibold text-gray-800">${item.name}</div>
                    <div class="text-sm text-gray-600">רווח: ${item.profit.toLocaleString()} מטבעות</div>
                    <div class="text-xs text-gray-500 mt-1">קנייה: ${item.buyPrice.toLocaleString()} | מכירה: ${item.sellPrice.toLocaleString()}</div>
                `;
                li.addEventListener('click', () => {
                    searchInput.value = item.name;
                    selectedItemId = item.name;
                    handleItemSelected();
                });
                profitListEl.appendChild(li);
            });
            showMessage(`נמצאו ${items.length} פריטים העומדים בדרישות.`, 'success');
        }

        // --- Event Listeners and State Management ---

        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            autocompleteList.innerHTML = '';
            
            if (searchTerm.length > 0) {
                const filteredItems = allBazaarItems.filter(item => item.toLowerCase().includes(searchTerm));
                
                if (filteredItems.length > 0) {
                    autocompleteList.classList.remove('hidden');
                    filteredItems.slice(0, 10).forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        li.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors duration-100';
                        li.addEventListener('click', () => {
                            searchInput.value = item;
                            selectedItemId = item;
                            autocompleteList.classList.add('hidden');
                            handleItemSelected();
                        });
                        autocompleteList.appendChild(li);
                    });
                } else {
                    autocompleteList.classList.add('hidden');
                }
            } else {
                autocompleteList.classList.add('hidden');
            }
        });

        document.addEventListener('click', (event) => {
            if (!searchInput.contains(event.target) && !autocompleteList.contains(event.target)) {
                autocompleteList.classList.add('hidden');
            }
        });

        findProfitButton.addEventListener('click', filterByProfit);

        function startUpdateIntervals() {
            clearInterval(updateLiveIntervalId);
            updateLiveIntervalId = setInterval(() => {
                if (selectedItemId) {
                    fetchBazaarData().then(() => {
                        updatePriceSummary();
                    });
                }
            }, 5000);
        }
        
        function handleItemSelected() {
            saveStateToLocalStorage();
            updatePriceSummary();
            startUpdateIntervals();
        }

        window.onload = async () => {
            const bazaarDataSuccess = await fetchBazaarData();
            if (bazaarDataSuccess) {
                const storedItemId = loadStateFromLocalStorage();
                if (storedItemId) {
                    if (allBazaarItems.includes(storedItemId)) {
                        selectedItemId = storedItemId;
                        searchInput.value = selectedItemId;
                        handleItemSelected();
                    } else {
                        showMessage("הפריט האחרון שנבחר לא זמין כעת. אנא חפש פריט אחר.", 'error');
                    }
                }
            }
        };
    </script>
</body>
</html>
